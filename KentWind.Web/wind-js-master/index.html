<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Wind Animation</title>

    <!--ORIGINAL CSS <link rel="stylesheet" href="https://js.arcgis.com/3.20/esri/css/esri.css"> -->
    <link rel="stylesheet" href="https://js.arcgis.com/3.23/esri/themes/calcite/dijit/calcite.css">
    <link rel="stylesheet" href="https://js.arcgis.com/3.23/esri/themes/calcite/esri/esri.css">
    <link rel="stylesheet" href="css/myStyle.css">
    <style>
      html,body {
        width:100%;
        height:100%;
        margin: 0;
        padding: 0px 0 0 0;
      }
      #HomeButton {
        position: absolute;
        top: 140px;
        left: 15px;
        z-index: 50;
      }
      #BasemapToggle {
        position: absolute;
        top: 75px;
        right: 20px;
        z-index: 50;
      }
      .basemapToggle {
        width: 50px;
        height: 50px;
      }
      .BasemapToggle .basemapTitle {
        width: 100%;
        background: #333333;
        color: #cccccc;
      }
      .BasemapToggle .toggleButton {
        background: #333333;
      }
      .esriSimpleSlider {
        background-color: #333333;
        color: white;
      }
      #mapCanvas {
        padding:0;
      }
    </style>

    <script>
      var dojoConfig = {
        paths: {
          plugins: location.pathname.replace(/\/[^/]+$/, "") + "/plugins"
        }
      };
    </script>
    <script src="./dataConvert.js"></script>
    <script src="./windy.js"></script>
    <script src="https://js.arcgis.com/3.20compact/"></script>
    <script>
      var map, rasterLayer;
      var canvasSupport;
      require([
        "esri/map", "esri/Color", "esri/symbols/SimpleMarkerSymbol",
	"esri/symbols/SimpleLineSymbol", "esri/geometry/Circle", "esri/symbols/SimpleFillSymbol",
        "esri/graphic", "esri/layers/GraphicsLayer", "esri/dijit/BasemapToggle",
        "esri/dijit/HomeButton", "esri/geometry/webMercatorUtils", "esri/layers/ArcGISTiledMapServiceLayer",
        "esri/domUtils", "esri/request",
        "dojo/parser", "dojo/number", "dojo/json", "dojo/dom",
        "dijit/registry", "plugins/RasterLayer","esri/layers/WebTiledLayer",
        "esri/config",
        "dojo/domReady!"
      ], function(
        Map, Color, SimpleMarkerSymbol, SimpleLineSymbol, Circle, SimpleFillSymbol,
        Graphic, GraphicsLayer, BasemapToggle, HomeButton, webMercatorUtils, ArcGISTiledMapServiceLayer,
        domUtils, esriRequest,
        parser, number, JSON, dom,
        registry, RasterLayer, WebTiledLayer, esriConfig
      ){
        parser.parse();
        // does the browser support canvas?
        canvasSupport = supports_canvas();
        map = new Map("mapCanvas", {
          center: [-81.3425, 41.1480],
          zoom: 16,
          basemap: "dark-gray",
          // streets-night-vector
          // satellite
          // streets
          // osm
          // hybrid
          // dark-gray-vector
          // dark-gray
          // topo
        });

      //   var points = [];
      //   for(var i = 0; i < data.length; i++) {
      //     points[i] = {
      //       type: "point",
      //       longitude: data[i].lon,
      //       latitude: data[i].lon
      //     }
      //   }
      //
      // var markerSymbol = {
      //    type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
      //    color: [226, 119, 40],
      //    outline: { // autocasts as new SimpleLineSymbol()
      //      color: [255, 255, 255],
      //      width: 6
      //    }
      //  };
      //
      // var pointGraphics = [];
      // for (var i = 0; i < points.length; i++) {
      //   pointGraphics[i] = new Graphic({
      //       geometry: points[i],
      //       symbol: markerSymbol
      //     });
      // }


        var home = new HomeButton({
          map: map
        }, "HomeButton");
        home.startup();

        var toggle = new BasemapToggle({
          map: map,
          basemap: "satellite"
        }, "BasemapToggle");
        toggle.startup();

        dojo.connect(map, "onMouseMove", showCoordinates);
        dojo.connect(map, "onMouseDrag", showCoordinates);
        dojo.connect(map, "onClick", logCoordinates);

        function showCoordinates(evt) {
          //the map is in web mercator but display coordinates in geographic (lat, long)
          var mp = webMercatorUtils.webMercatorToGeographic(evt.mapPoint);
          //display mouse coordinates
          dom.byId("info").innerHTML = mp.x.toFixed(5) + ", " + mp.y.toFixed(5);
        }

        function logCoordinates(evt){
          var mp = webMercatorUtils.webMercatorToGeographic(evt.mapPoint);
          console.log(mp.x.toFixed(5) + ", " + mp.y.toFixed(5));
        }

        map.on("load", mapLoaded);

        function mapLoaded() {

          function refreshData(){
            if ( canvasSupport ) {
              rasterLayer = new RasterLayer(null, {
                opacity: 1
              });
              map.addLayer(rasterLayer);
              map.on("extent-change", redraw);
              map.on("resize", function(){});
              map.on("zoom-start", redraw);

              var symbol = new SimpleFillSymbol().setColor(null).outline.setColor("blue");

              generateData();
              windy = new Windy({ canvas: rasterLayer._element, data: gfs });
              redraw();
              document.getElementById("reloadButton").addEventListener("click", function(){
                NEW_INFO_AVAILABLE = true;
              });
              document.getElementById("randomize").addEventListener("click", function(){
                map.removeLayer(rasterLayer);
                windy.stop();
                refreshData();
              });


              var gl = new GraphicsLayer({ id: "circles" });
              map.addLayer(gl);
              map.on("click", function(e) {
                var radius = 2;
                var circle = new Circle({
                  center: e.mapPoint,
                  radius: radius
                });
                var graphic = new Graphic(circle, symbol);
                gl.add(graphic);
              });

            } else {
              dom.byId("mapCanvas").innerHTML = "This browser doesn't support canvas. Visit <a target='_blank' href='http://www.caniuse.com/#search=canvas'>caniuse.com</a> for supported browsers";
            }
          }
          refreshData();
        }
        // does the browser support canvas?
        function supports_canvas() {
          return !!document.createElement("canvas").getContext;
        }

        function redraw(){
          rasterLayer._element.width = map.width;
          rasterLayer._element.height = map.height;
          windy.stop();
          var extent = map.geographicExtent;


          setTimeout(function(){
            windy.start(
              [[0,0],[map.width, map.height]],
              map.width,
              map.height,
              [[extent.xmin, extent.ymin],[extent.xmax, extent.ymax]]
            );
          },0);
        }
      });
    </script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  </head>

  <body class="calcite">
    <nav class="navbar navbar-inverse" style="margin-bottom: 0px;">
      <div class="container-fluid">
        <button id="reloadButton" class="btn btn-danger navbar-btn">Kill Switch</button>
        <button id="randomize" class="btn btn-danger navbar-btn">Randomize</button>

      </div>
    </nav>
    <div id="mapCanvas" class = "map" style="height:100%;">
      <div id="HomeButton"></div>
      <div id="BasemapToggle"></div>
      <span id="info" style="position:absolute; left:15px; bottom:10px; color:lightgrey; z-index:50;"></span>
    </div>
     </div>
  </body>

</html>
